<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Bar Übersicht</title>
		<script src="fontsize.js"></script>
		<script src="script.js"></script>		
		<link rel="stylesheet" href="style.css">
	</head>
	<body>
		<div id="order-filter-overlay" style="
			position: fixed; top: 90%; right: 5%; background: rgba(255,255,255,0.95);
			padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 9999;
			">
			<label>
			<input type="radio" name="orderFilter" value="today" checked> Heute
			</label>
			<label>
			<input type="radio" name="orderFilter" value="all"> Alle
			</label>
		</div>
		<h1>Bestellübersicht</h1>
		<div class="section" data-status="offen">
			<h2 onclick="toggleSection('offen')">- Offene Bestellungen (<span id="count-offen">0</span>)</h2>
			<div id="offen"></div>
		</div>
		<div class="section" data-status="in_bearbeitung">
			<h2 onclick="toggleSection('in_bearbeitung')">- In Bearbeitung (<span id="count-in_bearbeitung">0</span>)</h2>
			<div id="in_bearbeitung"></div>
		</div>
		<div class="section" data-status="fertig">
			<h2 onclick="toggleSection('fertig')">- Fertig (<span id="count-fertig">0</span>)</h2>
			<div id="fertig" class="hidden"></div>
		</div>
		<div style="margin-top: 75%" class="section" data-status="geloescht">
			<h2 onclick="toggleSection('geloescht')">- Papierkorb (<span id="count-geloescht">0</span>)</h2>
			<div id="geloescht" class="hidden"></div>
		</div>
		<script>
			let lastOrders = null;
			let lastFilter = "today";
			const BASE_URL = "http://192.168.2.92:8080";
			
			const containers = {
			  offen: document.getElementById("offen"),
			  in_bearbeitung: document.getElementById("in_bearbeitung"),
			  fertig: document.getElementById("fertig"),
			  geloescht: document.getElementById("geloescht")
			};
			
			function getFilterDate() {
			  if (lastFilter === "today") {
			    const today = new Date().toISOString().split("T")[0];
			    return `?date=${today}`;
			  }
			  return "";
			}
			
			function loadOrders() {
			  fetch(`${BASE_URL}/orders${getFilterDate()}`)
			    .then(res => res.json())
			    .then(data => {
			      if (JSON.stringify(data) === JSON.stringify(lastOrders) && lastFilter === getSelectedFilter()) {
			        return;
			      }
			
			      lastOrders = data;
			      lastFilter = getSelectedFilter();
			
			      Object.entries(containers).forEach(([status, el]) => {
			        el.innerHTML = "";
			        document.getElementById(`count-${status}`).textContent = "0";
			      });

				  const disableProgress = (status === "in_bearbeitung");
			
			      const counts = { offen: 0, in_bearbeitung: 0, fertig: 0, geloescht: 0 };
			      if (!data || Object.keys(data).length === 0) {
			        Object.keys(counts).forEach(status => {
			          document.getElementById(`count-${status}`).textContent = "0";
			        });
			        return;
			      }
			
			      Object.entries(data).forEach(([id, order]) => {
			        const status = order.status || "offen";
			        if (!containers[status]) return;
			
			        counts[status]++;
			        const drinksList = order.drinks.map((drink, i) => {
			          const isChecked = order.drinkStatus && order.drinkStatus[i];
			          return `
			            <label>
			              <input type="checkbox" class="drink-checkbox" data-order-id="${id}" data-drink-index="${i}" onchange="updateDrinkProgress('${id}')" ${isChecked ? 'checked' : ''}>
			              ${drink.amount}x ${drink.item} ${drink.size} 
			            </label>`;
			        }).join("<br>");
			
			        const div = document.createElement("div");
					const disableComplete = (status === "fertig");
			        div.className = `order ${status}`;
			        div.innerHTML = `
			          <p style="float: right;">${new Date(order.timestamp).toLocaleString("de-DE", {
					weekday: "long",   
					hour: "2-digit",   
					minute: "2-digit"  
					})} Uhr</p>
			          <p>Besteller: <strong>${order.name || "Unbekannt"}</strong></p>
			          <p style="margin-top: -10px;">Kommentar: <strong>${order.comment || "--"}</strong></p>
			          <p style="font-size: 1.3rem">${drinksList}</p>
			          <progress id="progress-${id}" value="0" max="${order.drinks.length}" style="width: 100%; margin: 5px 0;"></progress>
			          <p>Status: <span class="status">${order.status}</span></p>
			          <button class="actionButton" onclick="updateStatus('${id}', 'in_bearbeitung')">
			            <img src="icon/hourglass.svg" alt="In Bearbeitung" style="height: 1em;">
			          </button>
					<button style="background-color: #11990000; font-size: 2em;" id="complete-btn-${id}" onclick="updateStatus('${id}', 'fertig')" ${disableComplete ? "disabled" : ""}>
						<img src="icon/check.svg" alt="Fertig" style="height: 1em; vertical-align: middle;">
					</button>
					<button 
						style="float: right; background-color: #93141400; font-size: 2em;" 
						onclick="cancelOrder('${id}', '${status}')">
						<img src="icon/trash.svg" alt="Löschen" style="height: 1em; vertical-align: middle;">
					</button>
			        `;
			        containers[status].appendChild(div);
			        setTimeout(() => updateDrinkProgress(id), 0);
			      });
			
			      Object.entries(counts).forEach(([status, count]) => {
			        document.getElementById(`count-${status}`).textContent = count;
			      });
			    });
			}
			
			window.updateDrinkProgress = function(orderId) {
				const checkboxes = document.querySelectorAll(`.drink-checkbox[data-order-id="${orderId}"]`);
				const checkedStatus = Array.from(checkboxes).map(cb => cb.checked);
				const checkedCount = checkedStatus.filter(Boolean).length;

				const progress = document.getElementById(`progress-${orderId}`);
				const completeBtn = document.getElementById(`complete-btn-${orderId}`);

				if (progress) progress.value = checkedCount;
				if (completeBtn) completeBtn.disabled = (checkedCount !== checkboxes.length);

				const orderElement = checkboxes[0]?.closest(".order");
				const currentStatus = orderElement?.classList.contains("offen") ? "offen" : null;
				if (currentStatus === "offen" && checkedCount > 0) {
					updateStatus(orderId, "in_bearbeitung");
				}

				fetch(`${BASE_URL}/orders/${orderId}`, {
					method: "PUT",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ drinkStatus: checkedStatus })
				});
			};
			
			function updateStatus(orderId, newStatus) {
			  fetch(`${BASE_URL}/orders/${orderId}`, {
			    method: "PUT",
			    headers: { "Content-Type": "application/json" },
			    body: JSON.stringify({ status: newStatus })
			  }).then(() => loadOrders());
			}
			
			window.cancelOrder = function(orderId, currentStatus) {
				if (currentStatus !== "geloescht") {
					updateStatus(orderId, "geloescht");
				} else {
					if (confirm("Bestellung wirklich dauerhaft löschen?")) {
						fetch(`${BASE_URL}/orders/${orderId}`, { method: "DELETE" })
							.then(() => loadOrders())
							.catch(err => alert("Fehler beim endgültigen Löschen: " + err.message));
					}
				}
			};
			
			function toggleSection(status) {
			  document.getElementById(status).classList.toggle("hidden");
			}
			
			function getSelectedFilter() {
			  return document.querySelector('input[name="orderFilter"]:checked').value;
			}
			
			document.querySelectorAll('input[name="orderFilter"]').forEach(input => {
			  input.addEventListener("change", loadOrders);
			});
			
			loadOrders();
			setInterval(loadOrders, 3000);
		</script>
	</body>
</html>