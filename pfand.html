<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pfandr√ºckgabe</title>
    <script src="fontsize.js"></script>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1>Pfandr√ºckgabe</h1>
    <nav>
      <a style="margin-right: 15px;" href="index.html">Bestellansicht</a>
      <a href="admin.html">Adminansicht</a>
    </nav>

    <section style="margin-top: 30px; background: #eefaf5; padding: 15px; border-radius: 10px;">
      <h2>ü•§ Pfandausgabe</h2>
      <p>Becher aktuell im Umlauf: <span id="pfand-im-umlauf">?</span></p>
      <p>Gesamtwert des Pfands: <strong><span id="pfand-wert">0.00</span> <s>M</s></strong></p>
      <div style="margin-top: 10px; background: #c4f1e0; border-radius: 8px; overflow: hidden;">
        <div id="pfand-bar" style="height: 20px; width: 0%; background: #38b2ac;"></div>
      </div>
    </section>

    <form id="pfand-form" style="margin-top: 30px;">
      <label for="anzahl">Anzahl Becher zur√ºckgegeben:</label>
      <select id="anzahl" required></select>
      <button type="submit">Eintragen</button>
    </form>

    <script>
      const BASE_URL = "http://192.168.2.92:8080"; 

      const dropdown = document.getElementById("anzahl");
      for (let i = 1; i <= 20; i++) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = i;
        dropdown.appendChild(option);
      }

      document.getElementById("pfand-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const anzahl = parseInt(document.getElementById("anzahl").value);
        if (anzahl > 0) {
          fetch(`${BASE_URL}/pfand_rueckgaben`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              timestamp: Date.now(),
              anzahl: anzahl
            })
          }).then(res => res.json()).then(() => {
            alert("R√ºckgabe erfasst.");
            document.getElementById("pfand-form").reset();
            updatePfandAnzeige(); 
          });
        }
      });

      function updatePfandAnzeige() {
        Promise.all([
          fetch(`${BASE_URL}/orders`).then(res => res.json()),
          fetch(`${BASE_URL}/pfand_rueckgaben`).then(res => res.json())
        ]).then(([ordersData, rueckgabenData]) => {
          let ausgegeben = 0;
          let zur√ºck = 0;

          Object.values(ordersData || {}).forEach(order => {
            ausgegeben += order.pfand?.count || 0;
          });

          Object.values(rueckgabenData || {}).forEach(entry => {
            zur√ºck += entry.anzahl || 0;
          });

          const offen = Math.max(ausgegeben - zur√ºck, 0); 
          const pfandWert = offen * 1;

          document.getElementById("pfand-im-umlauf").textContent = offen;
          document.getElementById("pfand-wert").textContent = pfandWert.toFixed(2);

          const bar = document.getElementById("pfand-bar");
          const prozent = ausgegeben > 0 ? (offen / ausgegeben) * 100 : 0;
          bar.style.width = `${Math.min(prozent, 100).toFixed(1)}%`;
        }).catch(err => {
          console.error("Fehler beim Laden der Pfanddaten:", err);
        });
      }

      updatePfandAnzeige();
      setInterval(updatePfandAnzeige, 3000);

          function applyFontScale() {
    const savedScale = localStorage.getItem("font-scale") || "1";
    document.documentElement.style.setProperty("--font-scale", savedScale);
    document.body.style.fontSize = `${savedScale}em`;
  }

  applyFontScale();
    </script>
  </body>
</html>